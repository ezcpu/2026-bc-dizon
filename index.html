<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BC Region Performance 2026</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BC Performance">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3309/3309986.png">
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,{"name":"BC Region Performance","short_name":"BC Stats","start_url":".","display":"standalone","background_color":"#f4f1ea","theme_color":"#6b21a8","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3309/3309986.png","sizes":"512x512","type":"image/png"}]}'>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        :root {
            --bg-main: #f4f1ea; --sidebar-bg: #f9f7f2; --card-bg: #ffffff;
            --text-main: #1a1a1a; --text-muted: #7c7c7c;
            --accent-purple: #e9d5ff; --accent-purple-dark: #6b21a8;
            --status-green: #10b981; --status-red: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); line-height: 1.5; }

        .app-container { display: flex; min-height: 100vh; flex-direction: row; }

        .sidebar { width: 260px; background-color: var(--sidebar-bg); border-right: 1px solid #e5e2d9; padding: 40px 24px; display: flex; flex-direction: column; }
        .logo { font-size: 24px; font-weight: 800; margin-bottom: 48px; display: flex; align-items: center; gap: 10px; }
        .logo-box { width: 32px; height: 32px; background: var(--text-main); border-radius: 8px; transform: rotate(45deg); flex-shrink: 0; }
        
        .nav-section { margin-bottom: auto; }
        .nav-section h2 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 20px; }
        .nav-btn { width: 100%; padding: 14px 16px; border-radius: 12px; border: none; font-weight: 600; font-size: 14px; cursor: pointer; text-align: left; background: transparent; transition: 0.2s; margin-bottom: 8px; color: var(--text-muted); }
        .nav-btn:hover { background: #eeebe3; }
        .nav-btn.active { background: var(--accent-purple); color: var(--accent-purple-dark); }

        /* Integrated Install Button */
        .install-container { margin-top: 20px; border-top: 1px solid #e5e2d9; padding-top: 24px; }
        .install-btn { 
            width: 100%; padding: 12px 16px; border-radius: 12px; 
            border: 1px solid #e5e2d9; background: white; 
            font-weight: 600; font-size: 13px; color: var(--text-muted); 
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; 
        }
        .install-btn:hover { border-color: var(--text-muted); color: var(--text-main); }
        .install-icon { font-size: 16px; }

        .main-content { flex: 1; padding: 40px 60px; width: 100%; overflow-x: hidden; }
        .top-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; gap: 20px; }
        .welcome-msg h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        
        .month-tabs { display: flex; gap: 12px; margin-bottom: 32px; border-bottom: 1px solid #e5e2d9; padding-bottom: 12px; }
        .month-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid #e5e2d9; background: white; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; color: var(--text-muted); }
        .month-btn.active { background: var(--text-main); color: white; border-color: var(--text-main); }

        .section-label { font-size: 11px; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 16px; padding-left: 4px; }

        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px; }
        .card { 
            background: var(--card-bg); border-radius: 24px; padding: 32px; border: 1px solid #e5e2d9; 
            min-height: 220px; display: flex; flex-direction: column; justify-content: space-between; 
        }
        .card-header { color: var(--text-muted); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .card-value { font-size: 36px; font-weight: 800; margin-bottom: 4px; letter-spacing: -1px; }
        .card-subtext { font-size: 12px; color: var(--text-muted); font-weight: 500; display: flex; align-items: center; gap: 6px; }

        .indicator { font-weight: 700; font-size: 11px; padding: 2px 8px; border-radius: 6px; }
        .indicator.positive { background-color: #d1fae5; color: var(--status-green); }
        .indicator.negative { background-color: #fee2e2; color: var(--status-red); }

        .progress-wrapper { margin-top: 16px; height: 8px; background: #f0ede6; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.8s ease-out; background: var(--accent-purple-dark); border-radius: 10px; }

        .retail-list { margin-top: 10px; }
        .retail-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0ede6; font-size: 13px; font-weight: 600; }
        .retail-item:last-child { border-bottom: none; }
        .retail-label { color: var(--text-muted); font-weight: 500; }

        .sync-container { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .status-badge { display: flex; align-items: center; gap: 8px; background: white; padding: 6px 14px; border-radius: 12px; border: 1px solid #e5e2d9; font-size: 11px; font-weight: 700; cursor: pointer; }
        .sync-indicator { width: 6px; height: 6px; background: var(--status-green); border-radius: 50%; animation: pulse 2s infinite; }
        .latest-entry-label { font-size: 10px; color: var(--text-muted); font-weight: 600; padding-right: 4px; }
        
        /* Install Modal */
        #ios-install-modal {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            padding: 24px; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 1000;
            text-align: center;
        }
        .ios-icon { width: 24px; height: 24px; vertical-align: middle; margin: 0 4px; }
        .close-modal { position: absolute; top: 16px; right: 16px; font-size: 24px; cursor: pointer; color: #999; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        @media (max-width: 1024px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; padding: 20px; border-right: none; border-bottom: 1px solid #e5e2d9; }
            .nav-section { display: flex; flex-direction: row; gap: 10px; overflow-x: auto; margin-bottom: 0; }
            .nav-btn { width: auto; white-space: nowrap; margin-bottom: 0; }
            .install-container { margin-top: 10px; border-top: none; padding-top: 0; }
            .main-content { padding: 24px 20px; }
            .metrics-grid { grid-template-columns: 1fr; }
            .card { min-height: auto; }
            .sync-container { align-items: center; margin-top: 10px; }
            .top-header { flex-direction: column; align-items: center; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="logo"><div class="logo-box"></div> BC Region</div>
            <div class="nav-section">
                <button class="nav-btn active" data-location="Coquitlam">Coquitlam</button>
                <button class="nav-btn" data-location="Langley">Langley</button>
                <button class="nav-btn" data-location="North Van">North Van</button>
            </div>
            
            <div class="install-container">
                <button class="install-btn" id="installBtn" onclick="triggerInstall()">
                    <span class="install-icon">ðŸ“²</span> Add to Home Screen
                </button>
            </div>
        </nav>

        <main class="main-content">
            <header class="top-header">
                <div class="welcome-msg">
                    <h1 id="location-title">Performance Hub</h1>
                </div>
                <div class="sync-container">
                    <div class="status-badge" onclick="syncData()"><div class="sync-indicator"></div> <span id="sync-time">Syncing...</span></div>
                    <div id="latest-entry-label" class="latest-entry-label">Latest Entry: --</div>
                </div>
            </header>

            <div class="month-tabs">
                <button class="month-btn active" data-month="0">January</button>
                <button class="month-btn" data-month="1">February</button>
                <button class="month-btn" data-month="2">March</button>
            </div>

            <div class="section-label">Primary Metrics</div>
            <div class="metrics-grid">
                <div class="card">
                    <div>
                        <div class="card-header">Monthly Joins</div>
                        <div class="card-value" id="joins-value">0</div>
                        <div class="card-subtext">Target: <span id="joins-target">0</span> <span id="joins-indicator" class="indicator">--</span></div>
                    </div>
                    <div class="progress-wrapper"><div class="progress-fill" id="joins-progress"></div></div>
                </div>
                <div class="card">
                    <div>
                        <div class="card-header">Latest BCM Snapshot</div>
                        <div class="card-value" id="bcm-value">0%</div>
                        <div class="card-subtext">Goal: <span id="bcm-goal">0</span>% <span id="bcm-indicator" class="indicator">--</span></div>
                    </div>
                    <div class="progress-wrapper"><div class="progress-fill" id="bcm-progress" style="background-color: var(--accent-purple-dark);"></div></div>
                </div>
                <div class="card">
                    <div>
                        <div class="card-header">MTD Members</div>
                        <div class="card-value" id="members-value">0</div>
                        <div class="card-subtext">Prev. Year (2025): <span id="members-py">0</span></div>
                    </div>
                    <div class="progress-wrapper"><div class="progress-fill" id="members-progress" style="background-color: #10b981;"></div></div>
                </div>
            </div>

            <div class="section-label">Retail Performance</div>
            <div class="metrics-grid">
                <div class="card">
                    <div>
                        <div class="card-header">Total Retail Revenue</div>
                        <div class="card-value" id="retail-total">$0.00</div>
                        <div class="card-subtext">Selected Month Total</div>
                    </div>
                </div>
                <div class="card" style="grid-column: span 2; min-height: 220px;">
                    <div class="card-header">Revenue by Profit Center</div>
                    <div id="retail-breakdown" class="retail-list"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="ios-install-modal">
        <div class="close-modal" onclick="document.getElementById('ios-install-modal').style.display='none'">&times;</div>
        <h3>Install App</h3>
        <p style="color:#666; font-size:14px; margin-top:8px;">To add this app to your home screen:</p>
        <div style="margin-top:16px; font-weight:600; font-size:14px;">
            1. Tap the Share button <img src="https://cdn-icons-png.flaticon.com/512/1828/1828952.png" class="ios-icon"> below.<br><br>
            2. Scroll down and select "Add to Home Screen" <img src="https://cdn-icons-png.flaticon.com/512/3309/3309986.png" class="ios-icon">.
        </div>
    </div>

    <script>
        const PERFORMANCE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3wO2kEeMBkpwGu8WRho8oD7OJn02F3JPun-Lot-kyVs-137H6C68Y4N6WBh21H-WfLrSmT34030Hx/pub?output=csv';
        const RETAIL_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3wO2kEeMBkpwGu8WRho8oD7OJn02F3JPun-Lot-kyVs-137H6C68Y4N6WBh21H-WfLrSmT34030Hx/pub?gid=1518573577&single=true&output=csv';

        const budgetData = {
            'Coquitlam': { joins: { jan: 667, feb: 474, mar: 454 }, bcm: 50.92, formal: 'PLANET FITNESS COQUITLAM BC' },
            'Langley': { joins: { jan: 543, feb: 374, mar: 386 }, bcm: 60.61, formal: 'PLANET FITNESS LANGLEY BC' },
            'North Van': { joins: { jan: 332, feb: 291, mar: 285 }, bcm: 49.02, formal: 'PLANET FITNESS NORTH VANCOUVER BC' }
        };

        let rawP = [], rawR = [], currentLocation = 'Coquitlam', selectedMonthIndex = new Date().getMonth(); 
        let deferredPrompt; 

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        function triggerInstall() {
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            
            if (isIOS) {
                document.getElementById('ios-install-modal').style.display = 'block';
            } else if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => { deferredPrompt = null; });
            } else {
                alert("To install, look for 'Add to Home Screen' in your browser menu.");
            }
        }

        // STRICT Date Parser
        function getMonthFromAnyDate(str) {
            if (!str) return -1;
            const parts = str.trim().split(/[-/]/);
            if (parts.length < 3) return -1; 
            if (parts[0] === '2026') return parseInt(parts[1]) - 1; 
            if (parts[2] === '2026') return parseInt(parts[0]) - 1; 
            return -1; 
        }

        function cleanNum(val) { return parseFloat(val?.toString().replace(/[%\$,\s]/g, '')) || 0; }

        async function syncData() {
            try {
                const [pResp, rResp] = await Promise.all([
                    fetch(`${PERFORMANCE_URL}&v=${Date.now()}`),
                    fetch(`${RETAIL_URL}&v=${Date.now()}`)
                ]);
                rawP = Papa.parse(await pResp.text(), { header: false }).data;
                rawR = Papa.parse(await rResp.text(), { header: false }).data;
                document.getElementById('sync-time').textContent = `Live: ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
                updateDashboard();
            } catch (e) { console.error(e); }
        }

        function updateIndicator(id, diff, suffix = "") {
            const el = document.getElementById(id);
            if (!el) return;
            const symbol = diff >= 0 ? "+" : "";
            el.textContent = `${symbol}${diff.toFixed(diff % 1 === 0 ? 0 : 1)}${suffix}`;
            el.className = `indicator ${diff >= 0 ? "positive" : "negative"}`;
        }

        function updateDashboard() {
            const budget = budgetData[currentLocation];
            const target = budget.joins[['jan','feb','mar'][selectedMonthIndex]];
            document.getElementById('location-title').textContent = `${currentLocation} Hub`;

            const pMatches = rawP.filter(r => 
                r.some(c => c?.toString().toLowerCase().includes(currentLocation.toLowerCase())) &&
                getMonthFromAnyDate(r[4]) === selectedMonthIndex
            );

            if (pMatches.length > 0) {
                let j = 0; pMatches.forEach(r => { j += cleanNum(r[14]); });
                const lat = pMatches.reduce((l, c) => getMonthFromAnyDate(c[4]) >= getMonthFromAnyDate(l[4]) ? c : l);
                
                document.getElementById('latest-entry-label').textContent = `Latest Entry: ${lat[4]}`;
                document.getElementById('joins-value').textContent = Math.round(j).toLocaleString();
                document.getElementById('joins-target').textContent = target;
                document.getElementById('joins-progress').style.width = Math.min((j/target)*100, 100)+'%';
                updateIndicator('joins-indicator', j - target);
                
                const curBCM = cleanNum(lat[27]);
                document.getElementById('bcm-value').textContent = curBCM.toFixed(2) + '%';
                document.getElementById('bcm-goal').textContent = budget.bcm;
                document.getElementById('bcm-progress').style.width = Math.min((curBCM/budget.bcm)*100, 100)+'%';
                updateIndicator('bcm-indicator', curBCM - budget.bcm, "%");

                document.getElementById('members-value').textContent = Math.round(cleanNum(lat[11])).toLocaleString();
                document.getElementById('members-py').textContent = Math.round(cleanNum(lat[12])).toLocaleString();
                document.getElementById('members-progress').style.width = Math.min((cleanNum(lat[11])/cleanNum(lat[12]))*100, 100)+'%';
            }

            const rMatches = rawR.filter(r => 
                r[2]?.toString().trim().toUpperCase() === budget.formal.toUpperCase() &&
                getMonthFromAnyDate(r[0]) === selectedMonthIndex
            );

            const breakdown = document.getElementById('retail-breakdown');
            breakdown.innerHTML = '';
            let totalRev = 0;

            if (rMatches.length > 0) {
                const groups = {};
                rMatches.forEach(r => {
                    const rev = cleanNum(r[12]); 
                    const cat = r[4] || "Other"; 
                    totalRev += rev;
                    groups[cat] = (groups[cat] || 0) + rev;
                });

                document.getElementById('retail-total').textContent = `$${totalRev.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
                Object.entries(groups).sort((a,b) => b[1]-a[1]).forEach(([k, v]) => {
                    breakdown.innerHTML += `<div class="retail-item"><span class="retail-label">${k}</span><span>$${v.toLocaleString(undefined, {minimumFractionDigits: 2})}</span></div>`;
                });
            } else {
                document.getElementById('retail-total').textContent = '$0.00';
                breakdown.innerHTML = '<div style="color:#999; font-size:12px; padding:20px 0;">No matching retail rows found.</div>';
            }
        }

        document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', function() {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active'); currentLocation = this.dataset.location; updateDashboard();
        }));
        
        document.querySelectorAll('.month-btn').forEach(btn => btn.addEventListener('click', function() {
            document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active'); selectedMonthIndex = parseInt(this.dataset.month); updateDashboard();
        }));

        const currentBtn = document.querySelector(`.month-btn[data-month="${selectedMonthIndex}"]`);
        if (currentBtn) {
            document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
            currentBtn.classList.add('active');
        }

        syncData();
        setInterval(syncData, 300000);
    </script>
</body>
</html>
