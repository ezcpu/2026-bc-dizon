<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team KPI Dashboard 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f9fafb; color: #111827; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background-color: #ffffff; border-right: 1px solid #e5e7eb; padding: 24px; display: flex; flex-direction: column; }
        .sidebar h2 { font-size: 12px; font-weight: 700; color: #374151; margin-bottom: 24px; text-transform: uppercase; }
        .nav { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .nav button { width: 100%; padding: 12px 16px; border-radius: 8px; border: none; font-weight: 500; font-size: 14px; cursor: pointer; text-align: left; transition: all 0.2s; background-color: transparent; color: #374151; }
        .nav button.active { background-color: #e9d5ff; color: #6b21a8; }
        .main-content { flex: 1; padding: 32px; }
        .header { margin-bottom: 32px; position: relative; }
        .last-updated { font-size: 12px; color: #6b7280; margin-top: 4px; font-style: italic; display: flex; align-items: center; gap: 5px; }
        .sync-dot { height: 8px; width: 8px; background-color: #10b981; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px; }
        .metric-card { background-color: #ffffff; border-radius: 12px; border: 1px solid #e5e7eb; padding: 24px; }
        .metric-card h3 { font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 16px; }
        .metric-value { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .metric-subtext { font-size: 12px; color: #6b7280; margin-bottom: 12px; }
        .progress-bar { height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; transition: width 0.5s; background-color: #9333ea; }
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 32px; }
        .chart-card { background-color: #ffffff; border-radius: 12px; border: 1px solid #e5e7eb; padding: 24px; height: 350px; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 100; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>
    <div id="loader" class="loading-overlay">
        <div>Connecting to Live Spreadsheet...</div>
    </div>

    <div class="container">
        <div class="sidebar">
            <h2>Clubs</h2>
            <div class="nav">
                <button class="nav-btn active" data-location="Coquitlam">Coquitlam</button>
                <button class="nav-btn" data-location="Langley">Langley</button>
                <button class="nav-btn" data-location="North Van">North Van</button>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1 id="location-title">Club Performance 2026</h1>
                <p>Live CSV Data Syncing vs Q1 Budget Targets</p>
                <div id="timestamp" class="last-updated"><span class="sync-dot"></span> Waiting for sync...</div>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>MTD Joins (Col O)</h3>
                    <div class="metric-value" id="joins-value">0</div>
                    <div class="metric-subtext">Jan Target: <span id="joins-target">0</span></div>
                    <div class="progress-bar"><div class="progress-fill" id="joins-progress"></div></div>
                </div>

                <div class="metric-card">
                    <h3>BCM % (Col AB)</h3>
                    <div class="metric-value" id="bcm-value">0%</div>
                    <div class="metric-subtext">Target: <span id="bcm-target">0</span>%</div>
                    <div class="progress-bar"><div class="progress-fill" style="background-color: #3b82f6;" id="bcm-progress"></div></div>
                </div>

                <div class="metric-card">
                    <h3>MTD Members (Col L)</h3>
                    <div class="metric-value" id="members-value">0</div>
                    <div class="metric-subtext">Prior Year (Col M): <span id="members-py">0</span></div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Monthly Joins Target Achievement</h3>
                    <div style="height: 250px;"><canvas id="joinsChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3>BCM Performance vs Target</h3>
                    <div style="height: 250px;"><canvas id="bcmChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // BASE CSV URL
        const CSV_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3wO2kEeMBkpwGu8WRho8oD7OJn02F3JPun-Lot-kyVs-137H6C68Y4N6WBh21H-WfLrSmT34030Hx/pub?output=csv';

        const budgetData = {
            'Coquitlam': { joins: { jan: 667, feb: 476, mar: 454 }, bcm: 50.92 },
            'Langley': { joins: { jan: 543, feb: 374, mar: 386 }, bcm: 60.61 },
            'North Van': { joins: { jan: 332, feb: 291, mar: 285 }, bcm: 49.02 }
        };

        let liveDataStore = {};
        let chartInstances = { joins: null, bcm: null };
        let currentLocation = 'Coquitlam';

        // SYNC FUNCTION
        async function syncData() {
            try {
                // Add a unique timestamp to the URL to bypass browser cache
                const cacheBuster = `&t=${new Date().getTime()}`;
                const response = await fetch(CSV_BASE_URL + cacheBuster);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: false,
                    complete: (results) => {
                        processData(results.data);
                        
                        const now = new Date();
                        document.getElementById('timestamp').innerHTML = `<span class="sync-dot"></span> Live Sync: ${now.toLocaleTimeString()}`;
                        
                        document.getElementById('loader').style.display = 'none';
                        updateDashboard(currentLocation);
                    }
                });
            } catch (error) {
                console.error("Sync error:", error);
                document.getElementById('timestamp').innerHTML = "<b>⚠️ Sync Failed. Retrying...</b>";
            }
        }

        function processData(rows) {
            const locations = ['Coquitlam', 'Langley', 'North Van'];
            locations.forEach(loc => {
                const row = rows.find(r => r[0] && r[0].toLowerCase().includes(loc.toLowerCase()));
                if (row) {
                    liveDataStore[loc] = {
                        mtdMembers: row[11], 
                        mtdMembersPY: row[12], 
                        joins: parseFloat(row[14]) || 0, 
                        bcm: parseFloat(row[27]) || 0 
                    };
                }
            });
        }

        function updateDashboard(location) {
            currentLocation = location;
            const data = liveDataStore[location];
            if (!data) return;
            
            const budget = budgetData[location];

            document.getElementById('location-title').textContent = `${location} - Team Performance 2026`;
            document.getElementById('joins-value').textContent = data.joins;
            document.getElementById('joins-target').textContent = budget.joins.jan;
            document.getElementById('joins-progress').style.width = Math.min((data.joins / budget.joins.jan) * 100, 100) + '%';

            document.getElementById('bcm-value').textContent = data.bcm.toFixed(2) + '%';
            document.getElementById('bcm-target').textContent = budget.bcm;
            document.getElementById('bcm-progress').style.width = Math.min((data.bcm / budget.bcm) * 100, 100) + '%';

            document.getElementById('members-value').textContent = data.mtdMembers;
            document.getElementById('members-py').textContent = data.mtdMembersPY;

            renderCharts(data, budget);
        }

        function renderCharts(data, budget) {
            if (chartInstances.joins) chartInstances.joins.destroy();
            if (chartInstances.bcm) chartInstances.bcm.destroy();

            const ctxJoins = document.getElementById('joinsChart').getContext('2d');
            chartInstances.joins = new Chart(ctxJoins, {
                type: 'bar',
                data: {
                    labels: ['Actual (MTD)', 'Budget (Jan)'],
                    datasets: [{
                        data: [data.joins, budget.joins.jan],
                        backgroundColor: ['#9333ea', '#e5e7eb'],
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const ctxBcm = document.getElementById('bcmChart').getContext('2d');
            chartInstances.bcm = new Chart(ctxBcm, {
                type: 'doughnut',
                data: {
                    labels: ['BCM%', 'Gap'],
                    datasets: [{
                        data: [data.bcm, Math.max(0, budget.bcm - data.bcm)],
                        backgroundColor: ['#3b82f6', '#f3f4f6'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });
        }

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                updateDashboard(this.dataset.location);
            });
        });

        // INITIAL LOAD
        syncData();

        // AUTO-REFRESH EVERY 5 MINUTES (300,000 ms)
        setInterval(syncData, 300000);

    </script>
</body>
</html>
